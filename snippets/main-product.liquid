{%- render 'breadcrumbs' -%}

<div class="px-6 md:px-8 py-12">
    <div
            class="shopify-section-main-product-inner container mx-auto"
            data-handle="{{ product.handle }}"
            data-id="{{ product.id }}"
            data-url="{{ product.url }}"
            data-section="{{ section.id }}">

        <a class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 focus:z-50 focus:px-4 focus:py-2 focus:bg-white focus:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-400" href="#product-info-{{ section.id }}">
            Skip to product info
        </a>
        <div class="md:flex md:gap-12 pdp-main relative">
            <div class="media flex-1 mb-8 md:mb-0"
                 x-data="productGallery"
                 x-init="init()"
                 :class="galleryLayout === 'left' ? 'flex flex-row-reverse gap-4' : 'flex flex-col gap-4'">

                {%- comment -%} Main Image Display {%- endcomment -%}
                <div class="image-wrapper relative overflow-hidden pt-[137%] flex-1 group"
                     {% if section.settings.enable_zoom %}
                         @mousemove="handleZoomMove($event)"
                         @mouseleave="resetZoom()"
                         @click="{% if section.settings.zoom_type == 'lightbox' or section.settings.zoom_type == 'both' %}openLightbox(){% endif %}"
                         :class="{ 'cursor-zoom-in': zoomType === 'lightbox' || zoomType === 'both' }"
                     {% endif %}>
                    {% if product.selected_variant and product.selected_variant.image %}
                        {% assign media = product.selected_variant.image %}
                    {% else %}
                        {% assign media = product.featured_image %}
                    {% endif %}
                    {{ media | image_url: width: 1426 | image_tag:
                        class: "absolute h-full w-full object-cover inset-0 main-product-image transition-transform duration-200",
                        sizes: "(min-width: 768px) 55vw, 100vw",
                        widths: "800,1000,1426",
                        loading: "eager",
                        fetchpriority: "high",
                        x-ref: "mainImage",
                        style: "" }}
                </div>

                {%- comment -%} Thumbnail Navigation {%- endcomment -%}
                {% if section.settings.enable_gallery and product.images.size > 1 %}
                    <div class="thumbnail-navigation"
                         :class="{
                           'flex gap-2 overflow-x-auto': galleryLayout === 'bottom',
                           'flex flex-col gap-2 overflow-y-auto max-h-[600px] w-20': galleryLayout === 'left'
                         }">
                        {% for image in product.images %}
                            <button
                                type="button"
                                @click="selectImage({{ forloop.index0 }})"
                                :class="currentImageIndex === {{ forloop.index0 }} ? 'ring-2 ring-blue-500 ring-offset-2' : 'ring-1 ring-gray-200 hover:ring-gray-300'"
                                class="thumbnail-button flex-shrink-0 overflow-hidden transition-all focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2"
                                :style="`width: ${thumbnailSize}px; height: ${thumbnailSize}px;`"
                                aria-label="View image {{ forloop.index }}">
                                {{ image | image_url: width: 200 | image_tag:
                                    class: "w-full h-full object-cover",
                                    loading: "lazy",
                                    alt: image.alt | default: product.title }}
                            </button>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            <div class="info flex-1" id="product-info-{{ section.id }}">
                <p class="caption tracking-wide text-[10px] leading-3 text-gray-500">{{ product.type | upcase }}</p>
                <h1>{{ product.title }}</h1>
                <div class="flex items-center py-2" x-data="priceComponent()" x-init="init()">
                    <span class="sr-only">Regular Price</span>
                    <span
                            x-show="compareAtPrice"
                            x-text="formatMoney(compareAtPrice)"
                            class="line-through mr-2">
          </span>
                    <span
                            x-text="formatMoney(displayPrice)"
                            :class="{ 'transition-colors duration-300': flash }">
          </span>
                </div>
                {% render 'product-variant-picker'
                        , product: product
                        , product_form_id: 'product-form-id'
                        , picker_type: section.settings.picker_type %}

                <div x-data="productForm()" x-init="init()">
                    <div class="quantity-row space-y-1">
                        <label for="quantity-control-input" class="block text-sm font-medium text-gray-900">Quantity</label>
                        <div class="flex items-center border border-gray-300 w-fit text-gray-700 text-sm">
                            <button type="button" @click="decrementQuantity()" aria-label="Decrease quantity" class="w-11 h-11 bg-transparent border-0 flex items-center justify-center cursor-pointer focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-400 [&>svg]:w-[10px]">
                                {% render 'icon-minus' %}
                            </button>
                            <input
                                    type="number"
                                    id="quantity-control-input"
                                    x-model.number="quantity"
                                    min="1"
                                    aria-label="Quantity"
                                    class="w-12 text-center p-0 border-0 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-400 [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none">
                            <button type="button" @click="incrementQuantity()" aria-label="Increase quantity" class="w-11 h-11 bg-transparent border-0 flex items-center justify-center cursor-pointer focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-400 [&>svg]:w-[10px]">
                                {% render 'icon-plus' %}
                            </button>
                        </div>
                    </div>

                    <ajax-cart-product-form>
                        <form
                                action="{{ routes.cart_add_url }}"
                                id="product_form_id"
                                class="product-form my-6"
                                novalidate="novalidate"
                                data-product-form>
                            <input
                                    type="hidden"
                                    name="id"
                                    x-bind:value="variantId">
                            <input
                                    type="hidden"
                                    name="quantity"
                                    x-bind:value="quantity">
                            <div class="mb-2.5">
                                <button
                                        type="submit"
                                        name="add"
                                        class="bg-gray-900 text-white px-6 py-3 font-medium w-full hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                        x-bind:disabled="!isAvailable || isProcessing">
                  <span x-show="!isProcessing">
                    <span x-show="isAvailable">Add to cart</span>
                    <span x-show="!isAvailable">Sold out</span>
                  </span>
                                    <span x-show="isProcessing">Adding to cart...</span>
                                </button>
                            </div>
                            <div data-ajax-cart-errors="form" class="text-sm text-red-600">
                                <!-- Error messages appear here -->
                            </div>

                            <button
                                    type="button"
                                    x-show="isAvailable"
                                    class="bg-white text-gray-900 border border-gray-300 px-6 py-3 font-medium w-full hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
                                    @click="buyNow()">
                                Buy now
                            </button>

                            {{ form | payment_button }}
                        </form>
                    </ajax-cart-product-form>
                </div>

                <div class="description prose prose-base text-gray-700 leading-relaxed [&_em]:italic [&_a]:text-blue-500 [&_a:hover]:text-blue-600 [&_a]:underline [&_a:focus]:outline-none [&_a:focus]:ring-2 [&_a:focus]:ring-blue-400">
                    {{ product.description }}
                </div>
                {% for block in section.blocks %}
                    <div
                            x-data="{ expanded: false }"
                            class="collapsable-row border border-gray-200 my-4 rounded-lg overflow-hidden"
                            x-id="['collapsible-trigger', 'collapsible-panel']">
                        <h2 class="m-0">
                            <button
                                    type="button"
                                    class="w-full text-left bg-transparent border-0 p-0 appearance-none flex items-center justify-between px-6 py-4 text-xl font-semibold text-gray-900 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-400 transition-colors cursor-pointer"
                                    @click="expanded = !expanded"
                                    :aria-controls="$id('collapsible-panel')"
                                    :aria-expanded="expanded">
                                <span>{{ block.settings.heading }}</span>
                                <span
                                        class="text-gray-500 transition-transform duration-200"
                                        :class="{ 'rotate-180': expanded }">
                                    {% render 'icon-chevron' %}
                                </span>
                            </button>
                        </h2>
                        <div x-cloak x-show="expanded" x-collapse :id="$id('collapsible-panel')">
                            <div class="px-6 pb-4 text-gray-700">{{ block.settings.content }}</div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

</div>

{%- comment -%} Image Zoom Lightbox {%- endcomment -%}
{% if section.settings.enable_zoom and section.settings.zoom_type != 'hover' %}
    <div x-data="lightboxZoom"
         x-show="isOpen"
         x-cloak
         @keydown.escape.window="close()"
         class="fixed inset-0 z-50 bg-black bg-opacity-95 flex items-center justify-center p-4"
         @click.self="close()">
        <button type="button"
                @click="close()"
                class="absolute top-4 right-4 text-white hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-white p-2 z-10"
                aria-label="Close lightbox">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>

        <div class="max-w-6xl max-h-full overflow-auto">
            <img x-ref="lightboxImage"
                 src=""
                 alt=""
                 class="w-full h-auto"
                 @click.stop="">
        </div>

        {%- comment -%} Navigation arrows if multiple images {%- endcomment -%}
        {% if product.images.size > 1 %}
            <button type="button"
                    @click="previousImage()"
                    class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-white p-2"
                    aria-label="Previous image">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>

            <button type="button"
                    @click="nextImage()"
                    class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-white p-2"
                    aria-label="Next image">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        {% endif %}
    </div>
{% endif %}

<script>
    document.addEventListener('alpine:init', () => {
        let prod = {{ product | json }};
        prod.options_with_values = {{ product.options_with_values | json }};

        Alpine.store('productData', {
            product: prod,
            currentVariant: {{ product.selected_or_first_available_variant | json }},
            sectionId: '{{ section.id }}',
            optionsWithValues: {{ product.options_with_values | json }},
        });

        // Product Gallery Component
        Alpine.data('productGallery', () => ({
            currentImageIndex: 0,
            images: [],
            sectionId: null,
            galleryLayout: '{{ section.settings.gallery_layout | default: "bottom" }}',
            thumbnailSize: {{ section.settings.gallery_thumbnail_size | default: 80 }},
            zoomEnabled: {{ section.settings.enable_zoom | default: true }},
            zoomType: '{{ section.settings.zoom_type | default: "hover" }}',
            zoomLevel: {{ section.settings.zoom_level | default: 2 }},

            init() {
                const productData = Alpine.store('productData')
                const currentVariant = productData.currentVariant
                this.sectionId = productData.sectionId

                // Build images array from product data
                this.images = {{ product.images | json }}

                // Set initial image index based on variant or featured image
                if (currentVariant && (currentVariant.featured_media || currentVariant.featured_image)) {
                    const variantMedia = currentVariant.featured_media || currentVariant.featured_image
                    // Images array contains URL strings, not objects with id
                    // Compare by URL instead of id
                    const variantMediaSrc = variantMedia.src || variantMedia
                    const index = this.images.findIndex(img => {
                        const imgSrc = typeof img === 'string' ? img : img.src
                        return imgSrc && variantMediaSrc && imgSrc.includes(variantMediaSrc.split('?')[0].split('/').pop())
                    })
                    if (index !== -1) {
                        this.currentImageIndex = index
                    }
                }

                // Listen for variant:change events
                document.addEventListener('variant:change', (event) => {
                    if (event.detail.sectionId === this.sectionId) {
                        this.updateMediaForVariant(event.detail.variant)
                    }
                })
            },

            selectImage(index) {
                if (index >= 0 && index < this.images.length) {
                    this.currentImageIndex = index
                    this.updateMainImage(this.images[index])
                }
            },

            updateMediaForVariant(variant) {
                if (!variant) return

                const newMedia = variant.featured_media || variant.featured_image
                if (newMedia) {
                    // Images array contains URL strings, not objects with id
                    // Compare by URL instead of id
                    const newMediaSrc = newMedia.src || newMedia
                    const index = this.images.findIndex(img => {
                        const imgSrc = typeof img === 'string' ? img : img.src
                        return imgSrc && newMediaSrc && imgSrc.includes(newMediaSrc.split('?')[0].split('/').pop())
                    })
                    if (index !== -1) {
                        this.selectImage(index)
                    }
                }
            },

            updateMainImage(image) {
                if (!image) return

                const imgElement = this.$refs.mainImage

                // Handle both string URLs and image objects
                const imageSrc = typeof image === 'string' ? image : image.src
                const imageAlt = typeof image === 'object' && image.alt ? image.alt : {{ product.title | json }}

                if (imgElement && imageSrc) {
                    imgElement.src = this.getImageUrl(imageSrc, 1426)
                    imgElement.srcset = this.getImageSrcset(imageSrc)
                    imgElement.alt = imageAlt
                }
            },

            getImageUrl(src, width = null) {
                if (!src) return ''
                const baseUrl = src.split('?')[0]
                return width ? `${baseUrl}?width=${width}` : baseUrl
            },

            getImageSrcset(src) {
                if (!src) return ''
                const sizes = [800, 1000, 1426]
                return sizes.map(size => `${this.getImageUrl(src, size)} ${size}w`).join(', ')
            },

            // Zoom Methods
            handleZoomMove(event) {
                if (!this.zoomEnabled || (this.zoomType !== 'hover' && this.zoomType !== 'both')) return
                if (window.innerWidth < 768) return // Skip on mobile

                const imgElement = this.$refs.mainImage
                if (!imgElement) return

                const rect = event.currentTarget.getBoundingClientRect()
                const x = ((event.clientX - rect.left) / rect.width) * 100
                const y = ((event.clientY - rect.top) / rect.height) * 100

                imgElement.style.transformOrigin = `${x}% ${y}%`
                imgElement.style.transform = `scale(${this.zoomLevel})`
            },

            resetZoom() {
                const imgElement = this.$refs.mainImage
                if (imgElement) {
                    imgElement.style.transform = 'scale(1)'
                }
            },

            openLightbox() {
                if (!this.zoomEnabled) return
                window.dispatchEvent(new CustomEvent('open-lightbox', {
                    detail: {
                        imageIndex: this.currentImageIndex,
                        images: this.images
                    }
                }))
            }
        }))

        // Price Component
        Alpine.data('priceComponent', () => ({
            displayPrice: 0,
            compareAtPrice: null,
            flash: false,
            sectionId: null,

            init() {
                const productData = Alpine.store('productData')
                const currentVariant = productData.currentVariant
                this.sectionId = productData.sectionId
                this.displayPrice = currentVariant.price
                this.compareAtPrice = currentVariant.compare_at_price

                // Listen for variant:change events
                document.addEventListener('variant:change', (event) => {
                    if (event.detail.sectionId === this.sectionId) {
                        this.updatePrice(event.detail.variant)
                    }
                })
            },

            updatePrice(variant) {
                if (!variant) return

                const newPrice = variant.price
                const newCompareAtPrice = variant.compare_at_price

                if (newPrice !== this.displayPrice) {
                    // Trigger flash animation
                    this.flash = false
                    void this.$el.offsetWidth // force reflow

                    this.displayPrice = newPrice
                    this.compareAtPrice = newCompareAtPrice
                    this.flash = true

                    setTimeout(() => {
                        this.flash = false
                    }, 400)
                } else {
                    this.compareAtPrice = newCompareAtPrice
                }
            },

            formatMoney(cents) {
                return window.vast.helpers.formatMoney(cents, theme.moneyFormat || '${{amount}}')
            }
        }))

        // Product Form Component
        Alpine.data('productForm', () => ({
            quantity: 1,
            isProcessing: false,
            errorMessage: '',
            variantId: null,
            isAvailable: true,
            sectionId: null,

            init() {
                const productData = Alpine.store('productData')
                const currentVariant = productData.currentVariant
                this.sectionId = productData.sectionId
                this.variantId = currentVariant.id
                this.isAvailable = currentVariant.available

                // Listen for variant:change events
                document.addEventListener('variant:change', (event) => {
                    if (event.detail.sectionId === this.sectionId) {
                        this.handleVariantChange(event.detail.variant)
                    }
                })

                // Listen for liquid-ajax-cart events
                document.addEventListener('liquid-ajax-cart:request-start', () => {
                    this.isProcessing = true
                })

                document.addEventListener('liquid-ajax-cart:request-end', () => {
                    this.isProcessing = false
                })
            },

            handleVariantChange(variant) {
                if (!variant) return

                this.variantId = variant.id
                this.isAvailable = variant.available
                this.errorMessage = ''

                // Update the add-to-cart button text/state
                this.$nextTick(() => {
                    const addButton = this.$el.querySelector('button[type="submit"]')
                    if (addButton) {
                        addButton.disabled = !this.isAvailable
                    }
                })
            },

            incrementQuantity() {
                this.quantity++
            },

            decrementQuantity() {
                if (this.quantity > 1) {
                    this.quantity--
                }
            },

            buyNow() {
                if (!this.isAvailable) return
                window.location.href = `/cart/${this.variantId}:${this.quantity}`
            }
        }))

        // Lightbox Zoom Component
        Alpine.data('lightboxZoom', () => ({
            isOpen: false,
            currentIndex: 0,
            images: [],

            init() {
                // Listen for open-lightbox events from gallery
                window.addEventListener('open-lightbox', (event) => {
                    this.open(event.detail.imageIndex, event.detail.images)
                })

                // Listen for escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.isOpen) {
                        this.close()
                    }
                })

                // Listen for left/right arrow keys
                document.addEventListener('keydown', (e) => {
                    if (!this.isOpen) return
                    if (e.key === 'ArrowLeft') {
                        this.previousImage()
                    } else if (e.key === 'ArrowRight') {
                        this.nextImage()
                    }
                })
            },

            open(index, images) {
                this.currentIndex = index
                this.images = images
                this.isOpen = true
                this.updateLightboxImage()

                // Prevent body scroll
                document.body.style.overflow = 'hidden'
            },

            close() {
                this.isOpen = false
                document.body.style.overflow = ''
            },

            nextImage() {
                this.currentIndex = (this.currentIndex + 1) % this.images.length
                this.updateLightboxImage()
            },

            previousImage() {
                this.currentIndex = (this.currentIndex - 1 + this.images.length) % this.images.length
                this.updateLightboxImage()
            },

            updateLightboxImage() {
                const image = this.images[this.currentIndex]
                if (image && this.$refs.lightboxImage) {
                    // Handle both string URLs and image objects
                    const imageSrc = typeof image === 'string' ? image : image.src
                    const imageAlt = typeof image === 'object' && image.alt ? image.alt : {{ product.title | json }}

                    this.$refs.lightboxImage.src = this.getImageUrl(imageSrc, 2000)
                    this.$refs.lightboxImage.alt = imageAlt
                }
            },

            getImageUrl(src, width = null) {
                if (!src) return ''
                const baseUrl = src.split('?')[0]
                return width ? `${baseUrl}?width=${width}` : baseUrl
            }
        }))
    });
</script>
