<script>
    document.addEventListener('alpine:init', () => {
        let prod = {{ product | json }};
        prod.options_with_values = {{ product.options_with_values | json }};

        Alpine.store('productData', {
            product: prod,
            currentVariant: {{ product.selected_or_first_available_variant | json }},
            sectionId: '{{ section.id }}',
            optionsWithValues: {{ product.options_with_values | json }},
        });

        // Product Gallery Component
        Alpine.data('productGallery', () => ({
            currentMedia: null,
            sectionId: null,

            init() {
                const productData = Alpine.store('productData')
                const currentVariant = productData.currentVariant
                this.sectionId = productData.sectionId

                // Set initial media
                if (currentVariant && (currentVariant.featured_media || currentVariant.featured_image)) {
                    this.currentMedia = currentVariant.featured_media || currentVariant.featured_image
                }

                // Listen for variant:change events
                document.addEventListener('variant:change', (event) => {
                    if (event.detail.sectionId === this.sectionId) {
                        this.updateMedia(event.detail.variant)
                    }
                })
            },

            updateMedia(variant) {
                if (!variant) return

                const newMedia = variant.featured_media || variant.featured_image

                if (newMedia && newMedia.id !== this.currentMedia?.id) {
                    this.currentMedia = newMedia

                    // Update the image element
                    const imgElement = this.$el.querySelector('img')
                    if (imgElement && newMedia.src) {
                        imgElement.src = this.getImageUrl(newMedia.src)
                        imgElement.srcset = this.getImageSrcset(newMedia.src)
                        imgElement.alt = newMedia.alt || ''
                    }
                }
            },

            getImageUrl(src, width = null) {
                if (!src) return ''
                const baseUrl = src.split('?')[0]
                return width ? `${baseUrl}?width=${width}` : baseUrl
            },

            getImageSrcset(src) {
                if (!src) return ''
                const sizes = [800, 1000, 1426]
                return sizes.map(size => `${this.getImageUrl(src, size)} ${size}w`).join(', ')
            }
        }))

        // Price Component
        Alpine.data('priceComponent', () => ({
            displayPrice: 0,
            compareAtPrice: null,
            flash: false,
            sectionId: null,

            init() {
                const productData = Alpine.store('productData')
                const currentVariant = productData.currentVariant
                this.sectionId = productData.sectionId
                this.displayPrice = currentVariant.price
                this.compareAtPrice = currentVariant.compare_at_price

                // Listen for variant:change events
                document.addEventListener('variant:change', (event) => {
                    if (event.detail.sectionId === this.sectionId) {
                        this.updatePrice(event.detail.variant)
                    }
                })
            },

            updatePrice(variant) {
                if (!variant) return

                const newPrice = variant.price
                const newCompareAtPrice = variant.compare_at_price

                if (newPrice !== this.displayPrice) {
                    // Trigger flash animation
                    this.flash = false
                    void this.$el.offsetWidth // force reflow

                    this.displayPrice = newPrice
                    this.compareAtPrice = newCompareAtPrice
                    this.flash = true

                    setTimeout(() => {
                        this.flash = false
                    }, 400)
                } else {
                    this.compareAtPrice = newCompareAtPrice
                }
            },

            formatMoney(cents) {
                return window.vast.helpers.formatMoney(cents, theme.moneyFormat || '${{amount}}')
            }
        }))

        // Product Form Component
        Alpine.data('productForm', () => ({
            quantity: 1,
            isProcessing: false,
            errorMessage: '',
            variantId: null,
            isAvailable: true,
            sectionId: null,

            init() {
                const productData = Alpine.store('productData')
                const currentVariant = productData.currentVariant
                this.sectionId = productData.sectionId
                this.variantId = currentVariant.id
                this.isAvailable = currentVariant.available

                // Listen for variant:change events
                document.addEventListener('variant:change', (event) => {
                    if (event.detail.sectionId === this.sectionId) {
                        this.handleVariantChange(event.detail.variant)
                    }
                })

                // Listen for liquid-ajax-cart events
                document.addEventListener('liquid-ajax-cart:request-start', () => {
                    this.isProcessing = true
                })

                document.addEventListener('liquid-ajax-cart:request-end', () => {
                    this.isProcessing = false
                })
            },

            handleVariantChange(variant) {
                if (!variant) return

                this.variantId = variant.id
                this.isAvailable = variant.available
                this.errorMessage = ''

                // Update the add-to-cart button text/state
                this.$nextTick(() => {
                    const addButton = this.$el.querySelector('button[type="submit"]')
                    if (addButton) {
                        addButton.disabled = !this.isAvailable
                    }
                })
            },

            incrementQuantity() {
                this.quantity++
            },

            decrementQuantity() {
                if (this.quantity > 1) {
                    this.quantity--
                }
            },

            buyNow() {
                if (!this.isAvailable) return
                window.location.href = `/cart/${this.variantId}:${this.quantity}`
            }
        }))
    });
</script>

<div class="px-6 md:px-8 py-12">
    <div
            class="shopify-section-main-product-inner container mx-auto"
            data-handle="{{ product.handle }}"
            data-id="{{ product.id }}"
            data-url="{{ product.url }}"
            data-section="{{ section.id }}">

        <a class="skip-to-content-link" href="#product-info-{{ section.id }}">
            Skip to product info
        </a>
        <div class="md:flex md:gap-12 pdp-main relative">
            <div class="media flex-1 mb-8 md:mb-0" x-data="productGallery" x-init="init()">
                <div class="image-wrapper relative overflow-hidden pt-[137%]">
                    {% if product.selected_variant and product.selected_variant.image %}
                        {% assign media = product.selected_variant.image %}
                    {% else %}
                        {% assign media = product.featured_image %}
                    {% endif %}
                    {{ media | image_url: width: 1426 | image_tag:
                        class: "absolute h-full w-full object-cover inset-0",
                        sizes: "(min-width: 768px) 55vw, 100vw",
                        widths: "800,1000,1426",
                        loading: "eager",
                        fetchpriority: "high" }}
                </div>
                <span class="absolute top-0 left-0 z-100 text-[10px]">
          {{ product.selected_or_first_available_variant.id }}
        </span>
            </div>
            <div class="info flex-1" id="product-info-{{ section.id }}">
                <p class="caption tracking-wide text-[10px] leading-3 text-gray-500">{{ product.type | upcase }}</p>
                <h1>{{ product.title }}</h1>
                <div class="flex items-center py-2" x-data="priceComponent()" x-init="init()">
                    <span class="sr-only">Regular Price</span>
                    <span
                            x-show="compareAtPrice"
                            x-text="formatMoney(compareAtPrice)"
                            class="line-through mr-2">
          </span>
                    <span
                            x-text="formatMoney(displayPrice)"
                            :class="{ 'transition-colors duration-300': flash }">
          </span>
                </div>
                {% render 'product-variant-picker'
                        , product: product
                        , product_form_id: 'product-form-id'
                        , picker_type: section.settings.picker_type %}

                <div x-data="productForm()" x-init="init()">
                    <div class="quantity-row">
                        <label for="quantity-control-input">Quantity</label>
                        <div class="quantity-control-container">
                            <button type="button" @click="decrementQuantity()" aria-label="Decrease quantity">
                                {% render 'icon-minus' %}
                            </button>
                            <input
                                    type="number"
                                    id="quantity-control-input"
                                    x-model.number="quantity"
                                    min="1"
                                    aria-label="Quantity">
                            <button type="button" @click="incrementQuantity()" aria-label="Increase quantity">
                                {% render 'icon-plus' %}
                            </button>
                        </div>
                    </div>

                    <ajax-cart-product-form>
                        <form
                                action="{{ routes.cart_add_url }}"
                                id="product_form_id"
                                class="product-form"
                                novalidate="novalidate"
                                data-product-form>
                            <input
                                    type="hidden"
                                    name="id"
                                    x-bind:value="variantId">
                            <input
                                    type="hidden"
                                    name="quantity"
                                    x-bind:value="quantity">
                            <div class="mb-[10px]">
                                <button
                                        type="submit"
                                        name="add"
                                        class="px-6 hover:bg-cloud-burst-400 bg-blue-500 text-white w-full h-12 cursor-pointer disabled:cursor-not-allowed disabled:bg-gray-200 disabled:text-black"
                                        x-bind:disabled="!isAvailable || isProcessing">
                  <span x-show="!isProcessing">
                    <span x-show="isAvailable">Add to cart</span>
                    <span x-show="!isAvailable">Sold out</span>
                  </span>
                                    <span x-show="isProcessing">Adding to cart...</span>
                                </button>
                            </div>
                            <div data-ajax-cart-errors="form" class="text-red-500">
                                <!-- Error messages appear here -->
                            </div>

                            <button
                                    type="button"
                                    x-show="isAvailable"
                                    class="w-full h-12 px-6 text-white bg-blue-500 flex items-center justify-center hover:after:border-offset-1"
                                    @click="buyNow()">
                                Buy now
                            </button>

                            {{ form | payment_button }}
                        </form>
                    </ajax-cart-product-form>
                </div>

                <div class="description prose">
                    {{ product.description }}
                </div>
                {% for block in section.blocks %}
                    <div class="collapsable-row border border-gray-500 my-4 p-4">
                        <h2>{{ block.settings.heading }}</h2>
                        <div>{{ block.settings.content }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

</div>

<style>
    .section-main-product .shopify-section-main-product-inner .info fieldset label {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 40px;
        letter-spacing: 1px;
        font-size: 14px;
        cursor: pointer;
    }

    body:not(.using-mouse) .section-main-product .shopify-section-main-product-inner .info fieldset input:focus + label {
        outline: #08f auto 2px;
    }

    .section-main-product .shopify-section-main-product-inner .info fieldset label[data-unavailable='true'],
    .section-main-product .shopify-section-main-product-inner .info fieldset input[disabled] + label {
        background-color: transparent;
        color: lightgray;
    }

    .section-main-product .shopify-section-main-product-inner .info .quantity-row label {
        display: block;
        font-size: 13px;
        letter-spacing: 0.4px;
        line-height: 19.5px;
        color: rgba(26, 27, 24, 0.75);
        margin-bottom: 4px;
    }

    .section-main-product .shopify-section-main-product-inner .info .quantity-row .quantity-control-container {
        display: flex;
        align-items: center;
        border: 1px solid rgba(26, 27, 24, 0.55);
        max-width: max-content;
        color: rgba(26, 27, 24, 0.75);
        font-family: Arial;
        font-size: 14px;
    }

    .section-main-product .shopify-section-main-product-inner .info .quantity-row .quantity-control-container button {
        width: 45px;
        height: 45px;
        appearance: none;
        -webkit-appearance: none;
        background: transparent;
        border: none;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }

    .section-main-product .shopify-section-main-product-inner .info .quantity-row .quantity-control-container button svg {
        width: 10px;
    }

    .section-main-product .shopify-section-main-product-inner .info .quantity-row .quantity-control-container input {
        appearance: none;
        -webkit-appearance: none;
        border: none;
        width: 48px;
        text-align: center;
        padding: 0;
    }

    .section-main-product .shopify-section-main-product-inner .info .quantity-row .quantity-control-container input[type='number']::-webkit-inner-spin-button,
    .section-main-product .shopify-section-main-product-inner .info .quantity-row .quantity-control-container input[type='number']::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .section-main-product .shopify-section-main-product-inner .info form {
        margin: 25px auto;
    }

    .section-main-product .shopify-section-main-product-inner .info .description {
        font-size: 16px;
        line-height: 28.8px;
    }

    .section-main-product .shopify-section-main-product-inner .info .description em {
        font-style: italic;
    }

    .section-main-product .shopify-section-main-product-inner .info .description a {
        color: rgba(68, 89, 88, 0.85);
    }
</style>
{%- comment -%} schematic {%- endcomment -%}
{% schema %}
{
  "name": "Product Section",
  "tag": "section",
  "class": "section-main-product",
  "presets": [
    {
      "name": "Product Section"
    }
  ],
  "settings": [
    {
      "type": "radio",
      "id": "picker_type",
      "label": "Variant Picker Type",
      "default": "radio",
      "options": [
        {
          "value": "radio",
          "label": "Radio Buttons"
        },
        {
          "value": "select",
          "label": "Select Dropdowns"
        }
      ]
    }
  ],
  "blocks": [
    {
      "type": "collapsable_row",
      "name": "Collapsable Row",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content"
        }
      ]
    }
  ]
}
{% endschema %}